{% extends "base.html" %}
{% block head %}
    <link href="/static/css/dashboard.css" rel="stylesheet">    <style>
    <style>
    </style>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div id="root-view" class="row">
        </div>
    </div>
{% endblock %}
{% block foot %}
    <script type="text/template" id="meta-item-template">
        <a href="#<%=_id%>"><%=label%></a>
    </script>
    <script type="text/template" id="entity-row-template">
        <td>
            <div role="group" class="btn-group btn-group-xs">
                <button class="btn btn-info" type="button" title="Edit">
                    <span class="glyphicon glyphicon-pencil"></span>
                </button>
                <button class="btn btn-warning" type="button" title="Remove">
                    <span class="glyphicon glyphicon-remove-sign"></span>
                </button>
            </div>
        </td>
    </script>
    <script type="text/template" id="layout-view-template">
        <div class="col-sm-3 col-md-2 sidebar">
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <h1 class="page-header">Foo</h1>
            <!--p class="btn-toolbar">
                <div class="btn-group" role="group">
                    <button id="add-btn" type="button" class="btn btn-success btn-sm">
                    <span class="glyphicon glyphicon-plus"></span> Add
                    </button>
                </div>
                <div class="btn-group" role="group" data-toggle="buttons">
                    <label class="btn btn-primary btn-sm">
                        <input id="show-ids-chk" type="checkbox" autocomplete="off">
                        <span class="glyphicon glyphicon-list"></span> Show IDs
                    </label>
                    <label class="btn btn-primary btn-sm">
                        <input id="show-removed-chk" type="checkbox" autocomplete="off">
                        <span class="glyphicon glyphicon-remove-circle"></span> Show Removed
                    </input>
                </div>
            </p>
            <div class="table-responsive">
                <table id="the-grid" class="table table-condensed table-striped"></table>
            </div-->
        </div>
    </script>
    <script type="text/javascript">
        //----------------------------------------------------------------------
        // Application

        var EditorApp = Marionette.Application.extend({
            });

        var app = new EditorApp({});

        //----------------------------------------------------------------------
        // Models

        var MetaModel = Backbone.Model.extend({
                idAttribute: '_id',
            });

        var MetaCollection = Backbone.Collection.extend({
                model: MetaModel,
            });

        var EntityModel = Backbone.Model.extend({
                urlRoot: function () {
                    return '/api/kmod/' + app.meta.current.get('name');
                },
                idAttribute: '_id',
            });

        var EntityCollection = Backbone.Collection.extend({
                model: EntityModel,
                url: function () {
                    return '/api/kmod/' + app.meta.current.get('name');
                },
            });

        app.meta = new MetaCollection();

        //----------------------------------------------------------------------
        // Views

        var MetaItemView = Marionette.ItemView.extend({
                template: '#meta-item-template',
                tagName: 'li',
                onRender: function () {
                    if (this.model.id === app.meta.current.id) {
                        this.$el.addClass('active');
                    }
                },
            });

        var MetaCollectionView = Marionette.CollectionView.extend({
                childView: MetaItemView,
                tagName: 'ul',
                className: 'nav nav-sidebar',
            });

        var EntityRowView = Marionette.ItemView.extend({
                template: '#entity-row-template',
                tagName: "tr",
                className: function () {
                    if (this.model.get('removed')) return 'removed';
                    return '';
                },
                model: EntityModel,
                onRender: function () {
                    //this.$el.html(mk_tbl_row(meta,this.model));
                },
                ui: {
                    ed_btn: '.btn-info',
                    rm_btn: '.btn-warning',
                },
                events: {
                    'click @ui.ed_btn': 'onEdit',
                    'click @ui.rm_btn': 'onRemove',
                },
                onEdit: function () {
                    alert('Edit ' + this.model.id);
                },
                onRemove: function () {
                    alert('Remove ' + this.model.id);
                },
            }),

        var EntityTableView = Marionette.ItemView.extend({
                model: EntityCollection,

                collectionEvents: {
                    'sync': 'modelUpdated',
                    'add' : 'modelUpdated',
                },

                modelUpdated: function() {
                    this.render();
                },
            }),

        var LayoutView = Marionette.LayoutView.extend({
                el: '#root-view',
                template: "#layout-view-template",
                regions: {
                    sidebar: '.sidebar',
                    main: '.main',
                },
            });

        app.view = new LayoutView();
        app.side_view = new MetaCollectionView({collection: app.meta});

        //----------------------------------------------------------------------
        // Routing

        var MyController = Marionette.Controller.extend({
                edit_id: function (id) {
                    app.meta.current = app.meta.findWhere({_id:id});
                    app.side_view.render();
                    console.log("You are trying to edit " + id);
                },
            });

        app.router = new Marionette.AppRouter({
                controller: new MyController(),
                appRoutes: {
                    ":id": "edit_id",
                }
            });

        //----------------------------------------------------------------------
        // Startup

        app.on('start', function (options) {
            console.log('Editor starting...');
            this.view.render();
            this.meta.reset(options.data);
            this.meta.current = this.meta.head();
            this.view.showChildView('sidebar', this.side_view);
            Backbone.history.start();
            console.log('Editor started!');
        });

        // Load some initial data, and then start our application
        d3.json('/api/meta', function (meta) {
            app.start({data: meta});
        });
    </script>
{% endblock %}
