{% extends "base.html" %}
{% block head %}
<style>
    line.year {
        stroke: gray;
    }
    text.year {
        font-size: 11px;
        text-anchor: left;
        pointer-events: none;
    }
    rect.bar {
        fill: white;
        stroke: black;
        pointer-events: none;
    }
    text.bar {
        font-size: 11px;
        text-anchor: left;
        pointer-events: none;
    }
    rect.row {
        fill: white;
    }
    rect.odd {
        fill: #EEE;
    }
    rect.row:hover {
        fill: #FDB;
    }
    rect.impacting {
        fill: white;
    }
    rect.dependency {
        fill: #DDD;
    }
    rect.mhstp {
        fill: #C5E6FF;
    }
</style>
{% endblock %}
{% block content %}
    <p>Initiatives displayed on Gannt-like timeline.</p>
    <div id="diagram"></div>
    <script type="text/javascript">
        function mk_fyt(s) {
            var re = /FY(\d+)[ -]*(T(\d))?/i,
                m = re.exec(s);

            if (m && m[0]) {
                return {fy: Number(m[1]), t: Number(m[3] || '1')};
            }
            return null;
        }
        function fyt_col(fyt) {
            return fyt ? Math.max(0, (fyt.fy - 15 + (fyt.t-1)/3)) : 0;
        }
        function mk_class(s) {
            return s.toLowerCase().replace(/ /g, "").replace(/-/g, "");
        }

        var svg = d3.select("#diagram")
                    .append("svg");

        d3.csv("/bytime/init.csv", function(data) {
            var cols = 0,
                rows = 0,
                i = 0,
                n = data.length,
                inits = [];

            for (; i < n; i++) {
                var d = data[i]
                    s = mk_fyt(d.start),
                    e = mk_fyt(d.end);
                inits.push(d);
                rows += 1;
                cols = Math.max(cols, fyt_col(e));
            }

            var off = 300,
                colw = (900 - off) / cols,
                rowh = 15,
                w = off + cols * colw,
                h = (rows+1) * rowh;

            function row_rect(d, i) {
                d3.select(this)
                    .classed("row", true)
                    .classed("odd", (i+1)%2)
                    .attr({
                        x: 0,
                        y: (i+1) * rowh,
                        width: off + cols * colw,
                        height: rowh,
                    });
            }
            function init_bar(d, i) {
                var s = mk_fyt(d.start),
                    e = mk_fyt(d.end),
                    c = fyt_col(s),
                    w = fyt_col(e) - c;
                d3.select(this)
                    .classed("bar", true)
                    .classed(mk_class(d.category), true)
                    .attr({
                        x: off + c * colw + 1,
                        y: (i+1) * rowh + 2,
                        width: w * colw - 2,
                        height: rowh-4,
                    });
            }
            function init_text(d, i) {
                d3.select(this)
                    .classed("bar", true)
                    .text(d.name)
                    .attr({
                        x: 0,
                        y: (i+1) * rowh + 11,
                    });
            }
            function year_text(d) {
                d3.select(this)
                    .text("FY" + d)
                    .classed("year", true)
                    .attr({
                        x: off + (d-15) * colw + 1,
                        y: 10,
                    });
            }
            function year_line(d) {
                d3.select(this)
                    .classed("year", true)
                    .attr({
                        x1: off + (d-15) * colw,
                        y1: 0,
                        x2: off + (d-15) * colw,
                        y2: (rows+1) * rowh,
                    });
            }

            svg.attr("width", w+1)
               .attr("height", h);

            var years = [15,16,17,18,19,20,21,22];

            svg.selectAll("rect.row")
               .data(inits)
               .enter()
               .append("rect")
               .each(row_rect);

            svg.selectAll("text.year")
                .data(years)
                .enter()
                .append("text")
                .each(year_text);

            svg.selectAll("line.year")
                .data(years)
                .enter()
                .append("line")
                .each(year_line);

            svg.selectAll("rect.bar")
               .data(inits)
               .enter()
               .append("rect")
               .each(init_bar);

            svg.selectAll("text.bar")
               .data(inits)
               .enter()
               .append("text")
               .each(init_text);
        });
    </script>
{% endblock %}
