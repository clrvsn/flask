{% extends "base.html" %}
{% block head %}
<style>
    #tooltip {
        position: absolute;
        width: 250px;
        height: auto;
        padding: 5px;
        background-color: white;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
    }

    #tooltip.hidden {
        display: none;
    }

    #tooltip p, #tooltip td, #tooltip th {
        margin: 0;
        -font-family: sans-serif;
        font-size: 13px;
        line-height: 15px;
    }
    #tooltip table {
        border-collapse: collapse;
        width: 100%;
    }
    #tooltip td, #tooltip th {
        vertical-align: top;
        border: 1px solid #0063AD;
        padding: 4px;
    }
    #tooltip th {
        text-align: right;
    }
    #tooltip caption {
        caption-side: top;
        background: #0063AD;
        color: white;
        padding: 4px;
        font-size: 14px;
        font-weight: bold;
    }

    line.soft {
        stroke: grey;
        stroke-width: 8;
        opacity: 0.5;
    }
    line.soft:hover {
        stroke: orange;
        opacity: 1;
    }

    line.hard {
        stroke: black;
        stroke-width: 3;
        -opacity: 0.5;
    }
    line.hard:hover {
        stroke: orange;
        -opacity: 1;
    }

    g.prog rect {
        stroke: #BBB;
        stroke-width: 2;
        stroke-linejoin: round;
    }
    g.prog text {
        font-family: sans-serif;
        font-weight: bold;
        font-size: 13px;
        color: gray;
        --text-anchor: middle;
        pointer-events: none;
    }

    g.init rect {
        stroke-width: 3;
        stroke-linejoin: round;
    }
    g.init rect:hover {
        fill: orange;
    }
    g.init text {
        -font-family: sans-serif;
        font-size: 11px;
        text-anchor: middle;
        pointer-events: none;
    }
    p {
        font-family: sans-serif;
        -font-size: 1px;
    }
</style>
{% endblock %}
{% block content %}
    <p>Initiatives displayed by the Programme they belong to.</p>
    <div id="tooltip" class="hidden">
        <table>
            <tr><th>Status:</th> <td id="tt_stat"></td></tr>
            <tr><th>Type:</th> <td id="tt_type"></td></tr>
            <tr><th>Category:</th> <td id="tt_cat"></td></tr>
            <tr><th>Program:</th> <td id="tt_prog"></td></tr>
            <tr><th>Function:</th> <td id="tt_func"></td></tr>
            <tr><th>Start:</th> <td id="tt_start"></td></tr>
            <tr><th>End:</th> <td id="tt_end"></td></tr>
        </table>
    </div>
    <div id="diagram"></div>
    <p>Legend:</p>
    <img src="/static/byprog.legend.svg">
{% endblock %}
{% block foot %}
    <script type="text/javascript">
        var cols = 6,
            rows = 12,
            colw = 170,
            rowh = 65,
            w = cols * colw,
            h = rows * rowh + rowh/2,
            init_data = [],
            init_indx = {};

        var prog_data = [
                {col: 0, row: 0, cols: 2, rows: 3,  color: "#f7ffd4", name: "eCommerce"},
                {col: 0, row: 4, cols: 2, rows: 8,  color: "#fff6d4", name: "Planned Business"},
                {col: 2, row: 0, cols: 3, rows: 12, color: "#ffffd4", name: "MHS Transformation"},
                {col: 5, row: 0, cols: 1, rows: 6,  color: "#fff6d4", name: "Planned Business"},
            ];

        var svg = d3.select("#diagram")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

        svg.append("defs")
            .append("marker")
            .attr({
                id: "arrow",
                viewBox: "-20 -10 20 20",
                markerWidth: 12,
                markerHeight: 12,
                refx: 0,
                refy: 0,
                orient: "auto",
                markerUnits: "userSpaceOnUse"
            })
            .append("path")
            .attr({
                //d: "M2,2 L2,13 L8,7 L2,2",
                //d: "M0,0 L-13,7 L-13,-7 L0,0",
                d: "M-20,-8L0,0L-20,8",
                fill: "black",
            });

        var progs = svg.selectAll("g.prog")
                        .data(prog_data)
                        .enter()
                        .append("g")
                        .classed("prog", true);

        progs.append("rect")
            .attr({
                x: function(d) { return d.col * colw + 10; },
                y: function(d) { return d.row * rowh + 0; },
                width: function(d) { return d.cols * colw - 20; },
                height: function(d) { return d.rows * rowh - 0 + rowh/2; },
                fill: function(d) { return d.color; },
                rx: 10,
                ry: 10,
            });

        progs.append("text")
            .text(function(d) { return d.name; })
            .attr({
                x: function(d) { return d.col * colw + 20; },
                y: function(d) { return d.row * rowh + 10 + 12; },
            });

        function soft_line(d) {
            var d1 = init_indx[d.foo],
                d2 = init_indx[d.bar];
            //console.log(d)
            d3.select(this)
                .attr({
                    x1: d1.byprog_col * colw + colw/2,
                    y1: d1.byprog_row * rowh + rowh,
                    x2: d2.byprog_col * colw + colw/2,
                    y2: d2.byprog_row * rowh + rowh,
                });
        }
        function hard_line(d) {
            var d1 = init_indx[d.from],
                d2 = init_indx[d.to],
                r1 = mk_init_rect(d1),
                xk = r1.cx, yk = r1.cy,
                r2 = mk_init_rect(d2),
                xl = r2.cx, yl = r2.cy,
                xm = r2.l, ym = r2.t,
                xn = r2.r, yn = r2.t,
                xp = r2.r, yp = r2.b,
                xq = r2.l, yq = r2.b,
                p = intersect_lineseg_rect(xk,yk, xl,yl, xm,ym, xn,yn, xp,yp, xq,yq);
            //console.log(d)
            if (!p) {
                p = {x: xl, y: yl};
            }
            d3.select(this)
                .attr({
                    x1: xk, // d1.col * colw + colw/2,
                    y1: yk, // d1.row * rowh + rowh,
                    x2: p.x, // d2.col * colw + colw/2,
                    y2: p.y, // d2.row * rowh + rowh,
                    "marker-end": "url(#arrow)",
                });
        }

        function mk_init_rect(d) {
            var x = d.byprog_col * colw + 20,
                y = d.byprog_row * rowh + 10 + rowh/2,
                w = colw - 40,
                h = rowh - 20;
            return {
                l: x,
                t: y,
                r: x + w,
                b: y + h,
                w: w,
                h: h,
                cx: x + w/2,
                cy: y + h/2,
            };
        }

        function init_rect(d) {
            var r = mk_init_rect(d),
                typ = mk_class(d.type);
            d3.select(this)
                .classed(typ, true)
                .classed(mk_class(d.category), true)
                .classed(mk_class(d.state), true)
                .attr({
                    x: r.l,  y: r.t,  width: r.w,  height: r.h,
                    rx: typ === "project" ? 5 : (typ === "activity" ? (rowh-20)/2 : 0),
                    ry: typ === "project" ? 5 : (typ === "activity" ? (rowh-20)/2 : 0),
                })
        }

        //d3.csv("/byprog/init.csv", function(data) {
        d3.json("/api/byprog", function(data) {
            init_data = data.inits;

            init_data.forEach(function(ini) {
                init_indx[ini._id] = ini;
            });

            d3.csv("/static/soft.csv", function(data)
            {
                svg.selectAll("line.soft")
                    .data(data)
                    .enter()
                    .append("line")
                    .classed("soft", true)
                    .each(soft_line);

                d3.csv("/static/hard.csv", function(data)
                {

                    svg.selectAll("line.hard")
                        .data(data)
                        .enter()
                        .append("line")
                        .classed("hard", true)
                        .each(hard_line);
                    var gs = svg.selectAll("g.init")
                             .data(init_data)
                             .enter()
                             .append("g")
                             .classed("init", true);

                    gs.append("rect")
                        .each(init_rect);

                    gs.selectAll("text")
                        .data(function(d) {
                            var ns = d.byprog_txt.split("|");
                            return ns.map(function(n) {return {col: d.byprog_col, row: d.byprog_row, n: ns.length, name: n}; });
                        })
                        .enter()
                        .append("text")
                        .text(function(d) {return d.name})
                        .attr({
                            x: function(d) { return d.col * colw + colw/2; },
                            y: function(d, i) { return d.row * rowh + rowh/2 + (9 - d.n*6 + i*12) + rowh/2; },
                        });

                    $('.init').qtip({
                        content: {
                            title: function() {
                                var d = this.context.__data__;
                                return d.name;
                            },
                            text: function() {
                                var d = this.context.__data__,
                                    tt = d3.select("#tooltip");
                                //tt.select("#tt_name").text(d.name);
                                tt.select("#tt_stat").text(d.state);
                                tt.select("#tt_type").text(d.type);
                                tt.select("#tt_cat").text(d.category);
                                tt.select("#tt_prog").text(d.program);
                                tt.select("#tt_func").text(d['function']);
                                tt.select("#tt_start").text(d.start);
                                tt.select("#tt_end").text(d.end);
                                return tt.html();
                            },
                        },
                        style: {
                            classes: 'qtip-cluetip qtip-shadow'
                        },
                        position: {
                            my: 'left center',
                            at: 'center right',
                            viewport: $(window),
                            adjust: {
                                method: 'shift shift'
                            },
                        }
                    });

                });
            });
        });

    </script>
{% endblock %}